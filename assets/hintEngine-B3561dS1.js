var G=Object.defineProperty;var J=(t,o,n)=>o in t?G(t,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[o]=n;var S=(t,o,n)=>J(t,typeof o!="symbol"?o+"":o,n);function Q(t,o){for(let n=0;n<t.length;n++){let e=t[n];for(;e;){const s=e&-e,c=Z(s);o(n*64+c),e^=s}}}function Z(t){let o=0,n=t;for(;(n&1n)===0n;)n>>=1n,o++;return o}function tt(t,o){for(let n=0;n<t.length;n++)if((t[n]&~o[n])!==0n)return!1;return!0}class nt{constructor(o,n,e){S(this,"L");S(this,"R");S(this,"U");S(this,"D");S(this,"C");S(this,"rowId");S(this,"colSize");S(this,"nCols");S(this,"nPrimary");S(this,"root",0);S(this,"nodeCount");S(this,"colHeadBase",1);this.nCols=o,this.nPrimary=n,this.L=new Int32Array(e),this.R=new Int32Array(e),this.U=new Int32Array(e),this.D=new Int32Array(e),this.C=new Int32Array(e),this.rowId=new Int32Array(e),this.colSize=new Int32Array(this.colHeadBase+o+1),this.L[this.root]=this.root,this.R[this.root]=this.root,this.U[this.root]=this.root,this.D[this.root]=this.root;for(let s=1;s<=o;s++)this.C[s]=s,this.colSize[s]=0,this.U[s]=s,this.D[s]=s,this.L[s]=s-1,this.R[s]=s===o?this.root:s+1;this.L[1]=this.root,this.R[this.root]=o>=1?1:this.root,this.L[this.root]=o>=1?o:this.root,this.nodeCount=o+1}addRow(o,n){let e=-1,s=-1;for(let c=0;c<n.length;c++){const a=n[c],l=this.colHeadBase+a,r=this.nodeCount++;this.C[r]=l,this.rowId[r]=o;const h=this.U[l];if(this.U[r]=h,this.D[r]=l,this.D[h]=r,this.U[l]=r,this.colSize[l]++,e<0)e=r,s=r,this.L[r]=r,this.R[r]=r;else{const m=this.R[s];this.R[s]=r,this.L[r]=s,this.R[r]=m,this.L[m]=r,s=r}}}cover(o){this.R[this.L[o]]=this.R[o],this.L[this.R[o]]=this.L[o];for(let n=this.D[o];n!==o;n=this.D[n])for(let e=this.R[n];e!==n;e=this.R[e]){const s=this.C[e];this.D[this.U[e]]=this.D[e],this.U[this.D[e]]=this.U[e],this.colSize[s]--}}uncover(o){for(let n=this.U[o];n!==o;n=this.U[n])for(let e=this.L[n];e!==n;e=this.L[e]){const s=this.C[e];this.colSize[s]++,this.D[this.U[e]]=e,this.U[this.D[e]]=e}this.R[this.L[o]]=o,this.L[this.R[o]]=o}choosePrimaryColumnMinSize(){let o=-1,n=2147483647;for(let e=this.R[this.root];e!==this.root;e=this.R[e]){if(e-this.colHeadBase>=this.nPrimary)continue;const c=this.colSize[e];if(c<n&&(n=c,o=e,n<=1))break}return o}solve(o){const n=performance.now();let e=0,s=!1,c="complete";const a=[];let l;const r=m=>{if(performance.now()>=o.deadlineMs)return c="timeout",!1;let d=!1;for(let i=this.R[this.root];i!==this.root;i=this.R[i])if(i-this.colHeadBase<this.nPrimary){d=!0;break}if(!d)return e++,o.wantWitness&&!l&&(l=a.slice()),e>=o.limit?(s=!0,c="limit",!1):!0;const g=this.choosePrimaryColumnMinSize();if(g<0||this.colSize[g]===0)return!0;this.cover(g);for(let i=this.D[g];i!==g;i=this.D[i]){a.push(this.rowId[i]);for(let u=this.R[i];u!==i;u=this.R[u])this.cover(this.C[u]);const f=r();for(let u=this.L[i];u!==i;u=this.L[u])this.uncover(this.C[u]);if(a.pop(),!f&&(c==="limit"||c==="timeout"))return this.uncover(g),!1}return this.uncover(g),!0};r();const h=performance.now()-n;return{count:e,capped:s,reason:c,witness:l,elapsedMs:h}}}function ot(t){const o=performance.now(),n=t.limit??1e3,e=t.timeoutMs,s=performance.now()+e,c=!1,a=[];Q(t.open,k=>a.push(k));const l=a.length;if(l===0)return{feasible:!0,count:1,capped:!1,witness:c?[]:void 0,elapsedMs:performance.now()-o,reason:"complete"};const r=[];for(const k of Object.keys(t.remaining)){const C=Math.max(0,t.remaining[k]??0);for(let b=0;b<C;b++)r.push({pid:k,inst:b})}const h=r.length,m=l+h,d=new Map;for(let k=0;k<a.length;k++)d.set(a[k],k);const g=new Map;{let k=l;for(const C of Object.keys(t.remaining)){const b=Math.max(0,t.remaining[C]??0);b>0&&g.set(C,k),k+=b}}const i=[],f=new Set;for(const k of a){const C=t.bb.candsByTarget[k]??[];for(const b of C){if(!tt(b.mask,t.open)||(t.remaining[b.pid]??0)<=0)continue;const P=`${b.pid}:${b.ori}:${b.t.i},${b.t.j},${b.t.k}:${et(b.mask)}`;f.has(P)||(f.add(P),i.push({pid:b.pid,ori:b.ori,t:b.t,mask:b.mask,cellsIdx:b.cellsIdx}))}}if(i.length===0)return{feasible:!1,count:0,capped:!1,elapsedMs:performance.now()-o,reason:"complete"};let u=1+m;for(const k of i){const C=Math.max(0,t.remaining[k.pid]??0);u+=5*C}const I=new nt(m,l,u),p=[];for(let k=0;k<i.length;k++){const C=i[k],b=Math.max(0,t.remaining[C.pid]??0),U=g.get(C.pid);if(U===void 0)continue;const P=[];for(const L of C.cellsIdx){const $=d.get(L);if($===void 0){P.length=0;break}P.push($)}if(P.length===4)for(let L=0;L<b;L++){const $=p.length;p.push(C);const q=P.concat([U+L]);I.addRow($,q)}}const{count:y,capped:M,reason:w,witness:x,elapsedMs:O}=I.solve({limit:n,deadlineMs:s,wantWitness:c}),v=y>0,T=v&&c&&x?x.map(k=>p[k]):void 0;return{feasible:v,count:y,capped:M,witness:T,elapsedMs:O,reason:w}}function et(t){let o="";for(let n=0;n<t.length;n++)o+=t[n].toString(16)+"|";return o}function F(t,o){const n=new Map;t.cells.forEach((l,r)=>n.set(z(l),r));const e=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1],[1,-1,0],[-1,1,0],[1,0,-1],[-1,0,1],[0,1,-1],[0,-1,1]],s=t.cells.map(l=>{const r=[];for(const h of e){const m=[l[0]+h[0],l[1]+h[1],l[2]+h[2]],d=n.get(z(m));d!==void 0&&r.push(d)}return r}),c=t.cells.length,a=(1n<<BigInt(c))-1n;return{id:t.id,cells:t.cells,bitIndex:n,neighbors:s,pieces:o,N:c,occMaskAll:a}}function st(t){const o=t.N,n=Math.ceil(o/64),e=j(n);for(let i=0;i<o;i++)A(e,i);const s=Array.from({length:o},()=>E(n));for(let i=0;i<o;i++){const f=s[i];for(const u of t.neighbors[i])A(f,u)}const c=E(n),a=E(n);for(let i=0;i<o;i++){const f=t.cells[i];(f[0]+f[1]+f[2])%2===0?A(c,i):A(a,i)}let l=0x123456789abcdefn;function r(){return l^=l<<13n,l^=l>>17n,l^=l<<43n,l}const h=[];for(let i=0;i<o;i++)h.push(r());const m=new Map;for(const i of t.pieces.keys()){const u=[];for(let I=0;I<=10;I++)u.push(r());m.set(i,u)}const d=Array.from({length:o},()=>[]);function g(i){const f=E(n),u=[];for(const I of i){const p=t.bitIndex.get(`${I[0]},${I[1]},${I[2]}`);if(p===void 0)return null;A(f,p),u.push(p)}return{mask:f,idx:u}}for(const[i,f]of t.pieces.entries())for(const u of f)for(const I of u.cells)for(let p=0;p<o;p++){const y=t.cells[p],M=y[0]-I[0],w=y[1]-I[1],x=y[2]-I[2],O=u.cells.map(k=>[k[0]+M,k[1]+w,k[2]+x]),v=g(O);if(!v)continue;const T=[M,w,x];d[p].push({pid:i,ori:u.id,t:T,mask:v.mask,cellsIdx:v.idx})}for(let i=0;i<o;i++){const f=[],u=new Set;for(const I of d[i]){const p=it(I.mask),y=`${I.pid}:${I.ori}:${p}`;u.has(y)||(u.add(y),f.push(I))}d[i]=f}return{blockCount:n,occAllMask:e,candsByTarget:d,neighborBits:s,color0Blocks:c,color1Blocks:a,zCell:h,zInv:m}}function E(t){return new BigUint64Array(t)}function j(t){return new BigUint64Array(t)}function A(t,o){const n=o/64|0,e=BigInt(o%64);t[n]|=1n<<e}function it(t){let o="";for(let n=0;n<t.length;n++)o+=t[n].toString(16)+"|";return o}function ct(t,o){const n=j(t.length);for(let e=0;e<t.length;e++)n[e]=t[e]&~o[e];return n}function R(t,o){for(let n=0;n<t.length;n++){let e=t[n];for(;e;){const s=e&-e,c=Number(lt(s)),a=n*64+c;o(a),e^=s}}}function lt(t){let o=0n,n=t;for(;(n&1n)===0n;)n>>=1n,o++;return o}function z(t){return`${t[0]},${t[1]},${t[2]}`}const D={HINT_THRESHOLD:100,SOLVE_THRESHOLD:100,COUNT_LIMIT:1e5,TIMEOUT_MS:3e5};async function rt(){try{console.log("üì¶ Loading pieces from pieces_orientations.py...");const o=await(await fetch("/data/Pieces/pieces_orientations.py")).text(),n=at(o);return console.log(`‚úÖ Loaded ${n.size} pieces with orientations`),n}catch(t){throw console.error("‚ùå Failed to load pieces:",t),t}}function at(t){console.log("üîç parsePythonPieces: Parsing Python code..."),console.log(`   Code length: ${t.length} chars`);const o=new Map,n=t.match(/PIECES\s*=\s*\{([\s\S]*)\}/);if(!n)throw console.error("‚ùå parsePythonPieces: Could not find PIECES dictionary"),new Error("Could not find PIECES dictionary in Python file");console.log("‚úÖ parsePythonPieces: Found PIECES dictionary");const e=n[1],s=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y"];for(const c of s){const l=new RegExp(`"${c}":\\s*\\[`).exec(e);if(!l)continue;let r=1,h=l.index+l[0].length;for(;h<e.length&&r>0;)e[h]==="["?r++:e[h]==="]"&&r--,h++;const m=e.substring(l.index+l[0].length,h-1),d=[],g=/\[\s*\[\s*(-?\d+),\s*(-?\d+),\s*(-?\d+)\s*\],\s*\[\s*(-?\d+),\s*(-?\d+),\s*(-?\d+)\s*\],\s*\[\s*(-?\d+),\s*(-?\d+),\s*(-?\d+)\s*\],\s*\[\s*(-?\d+),\s*(-?\d+),\s*(-?\d+)\s*\]\s*\]/g;let i=0,f;for(;(f=g.exec(m))!==null;){const u=[[parseInt(f[1]),parseInt(f[2]),parseInt(f[3])],[parseInt(f[4]),parseInt(f[5]),parseInt(f[6])],[parseInt(f[7]),parseInt(f[8]),parseInt(f[9])],[parseInt(f[10]),parseInt(f[11]),parseInt(f[12])]];d.push({id:i++,cells:u})}d.length>0&&(o.set(c,d),console.log(`  ${c}: ${d.length} orientations`))}return console.log(`üì¶ Total pieces parsed: ${o.size} (expected 25: A-Y)`),console.log(`üì¶ Piece IDs found: ${Array.from(o.keys()).join(", ")}`),o}let ft=null;function ut(t){return`${t.i},${t.j},${t.k}`}function ht(t){return Array.isArray(t)?`${t[0]},${t[1]},${t[2]}`:`${t.i},${t.j},${t.k}`}function B(t){let o=0;for(;t;)t&=t-1n,o++;return o}function dt(t,o){const n=j(o);for(let e=0;e<o;e++){const s=(1n<<64n)-1n;n[e]=t>>BigInt(e*64)&s}return n}function N(t,o,n,e){let s=0n;for(const c of o){const a=[c[0]+n[0],c[1]+n[1],c[2]+n[2]],l=t.bitIndex.get(ht(a));if(l===void 0)return null;const r=1n<<BigInt(l);if(e&r)return null;s|=r}return s}function H(t,o,n){const e=o|n;if(e===t.occMaskAll)return!0;const s=t.N;let c=-1;for(let h=0;h<s;h++){const m=1n<<BigInt(h);if((e&m)===0n){c=h;break}}if(c<0)return!0;const a=~e&t.occMaskAll;let l=0n;const r=[c];for(l|=1n<<BigInt(c);r.length;){const h=r.shift();for(const m of t.neighbors[h]){const d=1n<<BigInt(m);a&d&&!(l&d)&&(l|=d,r.push(m))}}return l===a}function _(t,o){if((t.N-B(o))%4!==0)return!1;const e=~o&t.occMaskAll;let s=-1;for(let l=0;l<t.N;l++){const r=1n<<BigInt(l);if(e&r){s=l;break}}if(s<0)return!0;let c=0n;const a=[s];for(c|=1n<<BigInt(s);a.length;){const l=a.shift();for(const r of t.neighbors[l]){const h=1n<<BigInt(r);e&h&&!(c&h)&&(c|=h,a.push(r))}}return c===e}function X(t,o,n,e){let s=-1,c=Number.POSITIVE_INFINITY;for(let a=0;a<t.N;a++){const l=1n<<BigInt(a);if(o&l)continue;let r=0;for(const[h,m]of e.entries())if(!((n[h]??0)<=0)){for(const d of m){for(const g of d.cells){const i=[t.cells[a][0]-g[0],t.cells[a][1]-g[1],t.cells[a][2]-g[2]];if(N(t,d.cells,i,o)!==null&&(r++,r>=c))break}if(r>=c)break}if(r>=c)break}if(r<c&&(c=r,s=a,c===0))return a}return s}function V(t,o){let n=0n,e=0,s=0,c=0;for(const a of o){let l=0,r=0;for(const h of a.cells){e++;const m=t.bitIndex.get(ut(h));m!=null?(n|=1n<<BigInt(m),s++,l++):(c++,r++)}r>0&&console.warn("‚ö†Ô∏è [buildOccMask] Piece has cells outside container:",{pieceId:a.pieceId,totalCells:a.cells.length,inContainer:l,outside:r,cells:a.cells})}return console.log("üî¢ [buildOccMask] Summary:",{placedPiecesCount:o.length,totalCells:e,inContainer:s,outside:c,occBits:B(n),containerSize:t.N}),n}function W(t){const o={};for(const n of t)n.remaining==="infinite"?o[n.pieceId]=999:o[n.pieceId]=Math.max(0,n.remaining);return o}function K(t,o,n,e,s,c){if(console.log("üîé dfsSolvable start",{depth:e,occ:n.occ.toString(16)}),Date.now()>c||e>s)return!1;if(n.occ===t.occMaskAll)return console.log("‚úÖ Solution found at depth",e),!0;const a=X(t,n.occ,n.remaining,o);if(a<0)return console.log("‚ö†Ô∏è No target cell selected (dead end)"),!1;const l=t.cells[a];if(e===0){console.log("üîé Debug at depth 0:"),console.log("  target:",l),console.log("  piecesDb type:",o instanceof Map?"Map":"Object"),console.log("  piecesDb keys sample:",o instanceof Map?Array.from(o.keys()).slice(0,3):Object.keys(o).slice(0,3));const g=o instanceof Map?o.values().next().value:Object.values(o)[0];g&&g[0]&&(console.log("  first orientation sample:",g[0]),console.log("  has cells?","cells"in g[0]),console.log("  has ijkOffsets?","ijkOffsets"in g[0]))}let r=0,h=0,m=0,d=0;for(const[g,i]of o.entries())if(!((n.remaining[g]??0)<=0))for(const f of i)for(const u of f.cells){const I=[l[0]-u[0],l[1]-u[1],l[2]-u[2]],p=N(t,f.cells,I,n.occ);if(p===null){h++;continue}r++;const y=t.N-B(n.occ|p);if(y%4!==0){m++,e<=2&&console.log("üö´ dfsSolvable prune: mod4",{depth:e,openAfter:y,occHex:n.occ.toString(16),maskHex:p.toString(16)});continue}if(!H(t,n.occ,p)){d++,e<=2&&console.log("üö´ dfsSolvable prune: connectivity",{depth:e,openAfter:y,occHex:n.occ.toString(16),maskHex:p.toString(16)});continue}if(n.occ|=p,n.remaining[g]--,K(t,o,n,e+1,s,c))return!0;n.occ&=~p,n.remaining[g]++}return console.log("üîé dfsSolvable at depth",e,{targetIdx:a,candidateCount:r,prunedByMask:h,prunedByMod4:m,prunedByConnectivity:d}),!1}function Y(t,o,n,e,s,c,a=1e3){if(Date.now()>c||e>s)return 0;if(n.occ===t.occMaskAll)return 1;const l=X(t,n.occ,n.remaining,o);if(l<0)return 0;const r=t.cells[l];let h=0;for(const[m,d]of o.entries())if(!((n.remaining[m]??0)<=0)){if(h>=a)break;for(const g of d)for(const i of g.cells){if(h>=a)break;const f=[r[0]-i[0],r[1]-i[1],r[2]-i[2]],u=N(t,g.cells,f,n.occ);u===null||(t.N-B(n.occ|u))%4!==0||H(t,n.occ,u)&&(n.occ|=u,n.remaining[m]--,h+=Y(t,o,n,e+1,s,c,a-h),n.occ&=~u,n.remaining[m]++)}}return h}async function pt(){return await rt()}async function It(t,o){console.log("üì• [checkSolvableFromPartial] Input:",{containerCells:t.containerCells.length,placedPieces:t.placedPieces.length,placedPieceIds:t.placedPieces.map(f=>f.pieceId),remainingPieces:t.remainingPieces.length,mode:t.mode});const n=t.containerCells.map(f=>[f.i,f.j,f.k]),e=F({cells:n,id:t.mode},o),s=V(e,t.placedPieces),c=W(t.remainingPieces),a=e.N-B(s),l=a<=D.SOLVE_THRESHOLD;if(console.log("üß© [HintEngine] partial state for solvability:",{N:e.N,mode:t.mode,remaining:c,emptyCount:a,checkMode:l?"full":"lightweight"}),l&&a<=D.SOLVE_THRESHOLD){console.log("üéØ [HintEngine] Using DLX for solvability check (N=",a,")");try{const f=st(e),u=dt(s,f.blockCount),I=ct(f.occAllMask,u);let p=0;R(f.occAllMask,()=>{p++});let y=0;R(u,()=>{y++});let M=0;R(I,()=>{M++}),console.log("üîç [DLX Bitboard Check]:",{N:e.N,containerMaskBits:p,occBlocksBits:y,openBlocksBits:M,emptyCount:a});const w=ot({open:I,remaining:c,bb:f,timeoutMs:D.TIMEOUT_MS,limit:1e3,wantWitness:!1});if(console.log("üéØ [DLX] Result:",{feasible:w.feasible,count:w.count,capped:w.capped,elapsedMs:w.elapsedMs}),!w.feasible){let x=0;R(I,()=>{x++}),console.error("‚ùå [DLX] INFEASIBLE STATE:",{N:e.N,emptyCount:a,remaining:c,openCellsCount:x,containerCells:t.containerCells.length,placedPieces:t.placedPieces.length})}return{solvable:w.feasible,mode:"full",emptyCount:a,solutionCount:w.count,solutionsCapped:w.capped}}catch(f){console.warn("‚ö†Ô∏è [DLX] Failed, falling back to DFS:",f)}}if(!l){const f=_(e,s);return{solvable:f,mode:"lightweight",emptyCount:a,definiteFailure:!f}}const r=Date.now(),h=r+4e3,m=100,g=K(e,o,{occ:s,remaining:c},0,m,h);let i;if(g){const f={occ:s,remaining:{...c}},u=r+2e3;i=Y(e,o,f,0,m,u,1e3),console.log(`üî¢ [HintEngine] Found ${i}${i>=1e3?"+":""} solutions`)}return{solvable:g,mode:"full",emptyCount:a,solutionCount:i}}async function kt(t,o){const n=t.containerCells.map(d=>[d.i,d.j,d.k]),e=F({cells:n,id:t.mode},o),s=V(e,t.placedPieces),c=W(t.remainingPieces),a=e.N-B(s);console.log("üìä [Stats] Computing stats for partial state:",{emptyCount:a,remaining:c});let l=0;const r=gt(s,e.N);if(r!==null){const d=e.cells[r];for(const g of Object.keys(c)){if(c[g]<=0)continue;const i=o.get(g);if(i)for(const f of i){const u=f.cells;if(u.length===0)continue;const I=[d[0]-u[0][0],d[1]-u[0][1],d[2]-u[0][2]],p=N(e,u,I,s);if(!p)continue;const y=s|p;(e.N-B(y)===0||_(e,y))&&l++}}}const h=Object.values(c).reduce((d,g)=>d+g,0);let m;if(a>0&&h>0){const d=Math.min(h*5,50),g=Math.min(a,h),i=Math.pow(d,g);i>1e6?m=`‚âà10^${Math.floor(Math.log10(i))}`:i>1e3?m=`‚âà${(i/1e3).toFixed(1)}K`:m=`‚âà${Math.floor(i)}`}return console.log("üìä [Stats] Results:",{validNextMoveCount:l,estimatedSearchSpace:m}),{estimatedSearchSpace:m,validNextMoveCount:l}}function gt(t,o){for(let n=0;n<o;n++){const e=1n<<BigInt(n);if(!(t&e))return n}return null}export{It as checkSolvableFromPartial,kt as computeStatsFromPartial,pt as loadHintEnginePiecesDb};
