COPY-PASTE THIS TO CHATGPT:

===== START =====

# REVEAL SLIDER NOT SORTING BY VISUAL Y COORDINATE

## Problem
I have a 3D puzzle viewer that auto-orients puzzles using a view transformation matrix. I want a "reveal slider" to show pieces from ground-up based on their VISUAL Y position (after orientation), but it's not working correctly.

## The Data Flow
1. Puzzle cells in IJK lattice coordinates
2. Convert to XYZ: `ijkToXyz(ijk)` gives world coordinates
3. Auto-orient: Apply `view.M_world` (4x4 matrix) for visual orientation
4. Render in Three.js using the transformed coordinates

## My Sorting Code

**Utility function (`pieceYSorting.ts`):**
```typescript
function applyMatrix4(matrix: number[][], x: number, y: number, z: number) {
  const w = matrix[3][0] * x + matrix[3][1] * y + matrix[3][2] * z + matrix[3][3];
  return {
    x: (matrix[0][0] * x + matrix[0][1] * y + matrix[0][2] * z + matrix[0][3]) / w,
    y: (matrix[1][0] * x + matrix[1][1] * y + matrix[1][2] * z + matrix[1][3]) / w,
    z: (matrix[2][0] * x + matrix[2][1] * y + matrix[2][2] * z + matrix[2][3]) / w
  };
}

function calculatePieceCentroidY(
  cells: IJK[],
  ijkToXyz: (ijk: IJK) => { x: number; y: number; z: number },
  viewMatrix?: number[][]
): number {
  if (!cells || cells.length === 0) return 0;
  
  let sumY = 0;
  for (const cell of cells) {
    const xyz = ijkToXyz(cell);
    
    if (viewMatrix) {
      const transformed = applyMatrix4(viewMatrix, xyz.x, xyz.y, xyz.z);
      sumY += transformed.y;
    } else {
      sumY += xyz.y;
    }
  }
  
  return sumY / cells.length;
}

function sortPiecesByHeight(pieces, ijkToXyz, viewMatrix?) {
  const piecesWithHeight = pieces.map(piece => ({
    piece,
    centroidY: calculatePieceCentroidY(piece.cells, ijkToXyz, viewMatrix)
  }));
  
  piecesWithHeight.sort((a, b) => {
    const yDiff = a.centroidY - b.centroidY;
    if (Math.abs(yDiff) > 0.001) return yDiff;
    return a.piece.placedAt - b.piece.placedAt;
  });
  
  return piecesWithHeight.map(item => item.piece);
}
```

**How it's called:**
```typescript
const sorted = sortPiecesByHeight(
  Array.from(placed.values()), 
  ijkToXyz, 
  view?.M_world  // 4x4 transformation matrix
);
return sorted.slice(0, revealK);
```

**What view.M_world is:**
- A 4x4 transformation matrix
- Created by `computeViewTransforms()` which orients the puzzle so largest face is on ground
- Applied to all geometry before rendering in Three.js

## The Problem
The reveal slider does NOT build pieces from ground-up in the VISUAL orientation. It seems to use a different ordering than what I see on screen.

## Question
Is my matrix multiplication wrong? Should I be using the matrix differently? How do I correctly sort pieces by their visual Y position after the view transformation?

===== END =====
